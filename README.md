# Microsoft 365 Defender Threat Vulnerability add-on for Splunk <!-- omit in toc -->

 ## Table of contents <!-- omit in toc -->

- [About](#about)
- [TODO:](#todo)
  - [Recommendations](#recommendations)
- [Splunk configuration](#splunk-configuration)
  - [Installation](#installation)
  - [Configurations](#configurations)
- [Data collection](#data-collection)
- [Azure configurations](#azure-configurations)
  - [Resources](#resources)
  - [Permissions needed](#permissions-needed)
  - [Create app to collect data](#create-app-to-collect-data)
  - [Azure device tagging](#azure-device-tagging)
- [Troubleshooting](#troubleshooting)
  - [Azure authentication](#azure-authentication)
  - [Data collection](#data-collection-1)

## About

This repository is two-folded:

1. It holds a Splunk add-on which utilzes [MS Defender 365 vulnerabilties data](https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/get-assessment-software-vulnerabilities?view=o365-worldwide); CIM normalizes the data into the [Vulnerabilties data model](https://docs.splunk.com/Documentation/CIM/latest/User/Vulnerabilities) and creates asset lookup lists for Enterprise Security. 
2. Holds a python script which can be used to collect that said data to Splunk.


## TODO:

- [ ] Add picture of finished dashboard that's included.

### Recommendations

To further enchance your investigation options you should also be ingesting Defender for Endpoint events as well. We recommend using this add-on: 

- [Microsoft Defender for Endpoint Advanced Hunting Add-on for Splunk](https://github.com/splunk/TA-microsoft-365-defender-advanced-hunting-add-on)

## Splunk configuration

### Installation

#### Splunk Enterprise

Install the latest release package `TA-microsoft-365-defender-threat-vulnerability-add-on-<tag>.tar.gz` to the Splunk Search Head/SH Cluster via your usual methods.

Indexer(s) only needs `props.conf`, but it doesn't hurt to just install the whole add-on to them.

And if you rely on HFs for the data collection they need `props.conf` as well.

#### Splunk Cloud

Install the add-on via the GUI or using the Splunk [ACS API](https://docs.splunk.com/Documentation/SplunkCloud/latest/Config/ManageApps#Manage_private_apps_in_Splunk_Cloud_Platform) and you're all good!

### Configurations

#### Macros

The included dashboard and reports relies on macros.

1. `ms_defender_index` - needs to be set to where the vulnerability data is being indexed.
2. `get_system_from_machinetags(<regex>)` - this macro applies a given regex to the field `machineTags` in the lookup `ms_defender_endpoint_machines_assets.csv`

The last macro is needed to filter out unwanted Azure device tags in the dropdown menu of the dashboard, i.e. the inputed text functions as an allow list.
For example. if your tags are named _HR_, _Accounting_ and _IT Services_ the regex would be `get_system_from_machinetags((HR|Accounting|IT\sServices))`.

#### Lookup initalization

After data is being indexed, run and enable the reports included. Make sure to have set the macro `ms_defender_index` first.

1. `Lookup - MS Defender 365 - DeviceInfo`
2. `Lookup - MS Defender 365 - MachineInfo`
3. `Lookup - Vulnerabilities description`


## Data collection

The provided script collects data from three sources and needs to be set to run periodically , e.g. a cronjob.

Depending on your environment and knowledge, you can select multiple routes of collecting these events.

1. Use the script as is on a HF to forward the data.
2. Use Azure Functions to the write the json-data to either HEC or an EventHub. It's the function `write_results` that has to be modified towards the desired output.
3. Use Splunk SOAR / Cribl to query the APIs directly and post the data to Splunk

<img width="895" alt="17" src=https://user-images.githubusercontent.com/20418628/169668996-b60ace0a-82c2-4947-9272-f316f5b67379.png>


## Azure configurations

The collection script uses two of Microsofts APIs:

- [Defender 365 API](https://docs.microsoft.com/en-us/microsoft-365/security/defender/api-advanced-hunting?view=o365-worldwide) - `https://api.security.microsoft.com`
- [Defender for Endpoint](https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/run-advanced-query-api?view=o365-worldwide) - `https://api.securitycenter.microsoft.com`

### Resources 

- [Hello World for Microsoft 365 Defender REST API](https://docs.microsoft.com/en-us/microsoft-365/security/defender/api-hello-world?view=o365-worldwide)
- [Microsoft 365 Defender Advanced hunting API](https://docs.microsoft.com/en-us/microsoft-365/security/defender/api-advanced-hunting?view=o365-worldwide)


### Permissions needed 


| Collected data | API call | Permission needed | 
| -- | -- | -- |
| Machine info | `GET https://api.securitycenter.microsoft.com/api/machines` | Machine.Read.All |
| Full export of vulnerabilities | `GET https://api.securitycenter.microsoft.com/api/machines/SoftwareVulnerabilitiesExport`  | Vulnerability.Read.All | 
| Delta export of vulnerabilities | `GET https://api.securitycenter.microsoft.com/api/machines/SoftwareVulnerabilityChangesByMachine` | Vulnerability.Read.All |
| Description of vulnerabilities | `POST https://api.security.microsoft.com/api/advancedhunting/run` | AdvancedHunting.Read.All |

### Create app to collect data

<details>
  <summary>Click for a detailed walkthrough!</summary>

#### 1. App registration

Start of by registering the app that will be used in the script, for authentication.


<img width="837" alt="1" src="https://user-images.githubusercontent.com/50480144/169120546-dce5724a-8d5d-4b63-a0f5-92e0c1e3ca2d.png">

#### 2. Create a client secret

The secret will act as a password for the application in the OAuth flow.
Make sure to copy the value of the secret when creating it - this will only be shown once.
##### 2a. Add a client secret

<img width="1162" alt="2" src="https://user-images.githubusercontent.com/50480144/169120617-a64b10dc-6af7-492a-83b6-4a9a5aab50b7.png">

<img width="1125" alt="3" src="https://user-images.githubusercontent.com/50480144/169120630-3ea833fc-a8ea-4ff4-ab10-9abde4ccd0d1.png">

<img width="1432" alt="4" src="https://user-images.githubusercontent.com/50480144/169120635-90240e41-f884-4021-b44f-07b2ce72bdb3.png">

##### 2b. Copy ID and Secret (value)
<img width="1174" alt="5" src="https://user-images.githubusercontent.com/50480144/169120650-5365c518-54b3-4fbd-a4c3-4a49faca3e47.png">

#### 3. Add API Permissions to the app

<img width="1177" alt="6" src="https://user-images.githubusercontent.com/50480144/169120659-0283cfc1-0681-4f2a-9b41-bd8f3f49c09f.png">

##### 3a. API Permissions - Microsoft Threat Protection

Needed permission `AdvancedHunting.Read.All`

<img width="1421" alt="7" src="https://user-images.githubusercontent.com/50480144/169120666-979b6227-a0d3-4af9-bf0e-116d8896f500.png">

<img width="1426" alt="8" src="https://user-images.githubusercontent.com/50480144/169120673-019ac4cf-57e0-486c-88dc-252d562da8f1.png">

<img width="1419" alt="9" src="https://user-images.githubusercontent.com/50480144/169120679-95eab735-8743-49b2-bf11-8f937426194e.png">

##### 3b. API Permissions - WindowsDefenderATP

Needed permissions `Machine.Read.All` and `Vulnerability.Read.All`

<img width="1425" alt="10" src="https://user-images.githubusercontent.com/50480144/169120683-4c9cdbfb-881a-4315-850a-9d505034da76.png">

<img width="1423" alt="11" src="https://user-images.githubusercontent.com/50480144/169120690-b6bc28e8-ab19-4a77-9527-44162a8d9834.png">

<img width="1421" alt="12" src="https://user-images.githubusercontent.com/50480144/169120694-769314e3-5117-484e-9a40-20f191f22dc8.png">

<img width="1430" alt="13" src="https://user-images.githubusercontent.com/50480144/169120696-fb0837aa-ff72-425f-998e-b974a3f90ba8.png">

#### 4. Get an Azure admin to grant consent to the application permissions
<img width="1188" alt="14" src="https://user-images.githubusercontent.com/50480144/169125882-5528de41-f8bc-4830-8597-cb00073d3817.png">

#### 5. Success!
<img width="1185" alt="15" src="https://user-images.githubusercontent.com/50480144/169125903-0b4f4d94-ace3-44b1-9680-c8af5147a4b1.png">

#### 6. Go back to your app and take note of the Client ID and Tenant ID
<img width="790" alt="16" src="https://user-images.githubusercontent.com/50480144/169125916-4d90f4dd-2391-473d-8bb2-029fd73d9024.png">

#### 7. Use the credentials

In the config script either uncomment and use a Key Vault, or fill in hardcoded values (not recommended)

<img width="895" alt="17" src="https://user-images.githubusercontent.com/50480144/169125925-68fd656b-d41b-428e-9d59-7166028cb127.png">

</details>

### Azure device tagging

Setting custom tags on the devices lets us categorize which business system a device belongs to, if this information isn't coming to Splunk from some other place.

A tag can be e.g. `HR` or `IT Support`, and they can be set using GPO / Powershell / Intune / API.
Using the API is probably preferable since it can be used regardless of the machine OS.

There are a couple of points to be aware of when you are using the registry to tag a machine:

1. The tag is fixed and cannot be changed through the portal, it can only be changed by modifying the registry.
2. Only one tag can be specified in the registry.

See below links for guides and code
- [How to use tagging effectively (Part 1)](https://techcommunity.microsoft.com/t5/microsoft-defender-for-endpoint/how-to-use-tagging-effectively-part-1/ba-p/1964058)
- [How to use tagging effectively (Part 2)](https://techcommunity.microsoft.com/t5/microsoft-defender-for-endpoint/how-to-use-tagging-effectively-part-2/ba-p/1962008)
- [How to use tagging effectively (Part 3) - Scripting tags](https://techcommunity.microsoft.com/t5/microsoft-defender-for-endpoint/how-to-use-tagging-effectively-part-3-scripting-tags/ba-p/1964073)

#### Tagging using the Defender 365 portal

1. Open the Defender 365 portal and select _Device Inventory_ 

<img width="800" alt="18" src="https://user-images.githubusercontent.com/20418628/172121790-556970e0-38cb-49a6-b48c-e5f752a5acab.png">

2. Select a device and assign it a tag

<img width="600" alt="19" src="https://user-images.githubusercontent.com/20418628/172121957-dda524af-ca5e-429a-a7de-aeb9f644a317.png">

3. How the device tag is shown in Splunk

<img width="400" alt="20" src="https://user-images.githubusercontent.com/20418628/172121958-a487fcd5-b374-4137-83b6-3ad3e3d147f0.png">


## Troubleshooting

### Azure authentication

You can use [jwt.ms](https://jwt.ms/) to validate that your returned auth token has the correct `roles`

### Data collection

If the delta export is set to run too often (e.g. every hour) it's been observed that the output file is blank. Defender doesn't update its tables in real time.
