# Microsoft Advanced Hunting

This Technical Add-on uses the Microsoft Advanced Hunting API.

You can use two different API's:

- [Defender 365 API](https://docs.microsoft.com/en-us/microsoft-365/security/defender/api-advanced-hunting?view=o365-worldwide) `https://api.security.microsoft.com`
- [Defender for Endpoint](https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/run-advanced-query-api?view=o365-worldwide) `https://api.securitycenter.microsoft.com`

Usage:

1. Create and use the auth token from the registered enterprise application.
2. Run POST calls to the endpoint with a KQL `query` as input data.

Recommendations:

You should also be ingesting Defender for Endpoint data as well. We recommend using this add-on: 

- [Microsoft Defender for Endpoint Advanced Hunting Add-on for Splunk](https://github.com/splunk/TA-microsoft-365-defender-advanced-hunting-add-on)

## Preparing your Azure environment

Start of by registering the app that will be used in the script, for authentication.

#### 1. App registration
<img width="837" alt="1" src="https://user-images.githubusercontent.com/50480144/169120546-dce5724a-8d5d-4b63-a0f5-92e0c1e3ca2d.png">

#### 2. Create a client secret
<img width="1162" alt="2" src="https://user-images.githubusercontent.com/50480144/169120617-a64b10dc-6af7-492a-83b6-4a9a5aab50b7.png">

#### 3. Create a client secret
<img width="1125" alt="3" src="https://user-images.githubusercontent.com/50480144/169120630-3ea833fc-a8ea-4ff4-ab10-9abde4ccd0d1.png">

#### 4. Add a client secret
<img width="1432" alt="4" src="https://user-images.githubusercontent.com/50480144/169120635-90240e41-f884-4021-b44f-07b2ce72bdb3.png">

#### 5. Copy ID and Secret (value)
<img width="1174" alt="5" src="https://user-images.githubusercontent.com/50480144/169120650-5365c518-54b3-4fbd-a4c3-4a49faca3e47.png">

#### 6. API Permissions
<img width="1177" alt="6" src="https://user-images.githubusercontent.com/50480144/169120659-0283cfc1-0681-4f2a-9b41-bd8f3f49c09f.png">

#### 7. API Permissions (Microsoft.Threat.Protection)
<img width="1421" alt="7" src="https://user-images.githubusercontent.com/50480144/169120666-979b6227-a0d3-4af9-bf0e-116d8896f500.png">

#### 8. Select Application Permissions
<img width="1426" alt="8" src="https://user-images.githubusercontent.com/50480144/169120673-019ac4cf-57e0-486c-88dc-252d562da8f1.png">

#### 9. Select the shown roles (AdvancedHunting.Read.All)
<img width="1419" alt="9" src="https://user-images.githubusercontent.com/50480144/169120679-95eab735-8743-49b2-bf11-8f937426194e.png">

#### 10. API Permissions (WindowsDefenderATP)
<img width="1425" alt="10" src="https://user-images.githubusercontent.com/50480144/169120683-4c9cdbfb-881a-4315-850a-9d505034da76.png">

#### 11. Select Application Permissions
<img width="1423" alt="11" src="https://user-images.githubusercontent.com/50480144/169120690-b6bc28e8-ab19-4a77-9527-44162a8d9834.png">

#### 12. Select the role (Machine.Read.All)
<img width="1421" alt="12" src="https://user-images.githubusercontent.com/50480144/169120694-769314e3-5117-484e-9a40-20f191f22dc8.png">

#### 13. Select the role (Vulnerability.Read.All)
<img width="1430" alt="13" src="https://user-images.githubusercontent.com/50480144/169120696-fb0837aa-ff72-425f-998e-b974a3f90ba8.png">

#### 14. Get an admin to give consent
<img width="1188" alt="14" src="https://user-images.githubusercontent.com/50480144/169125882-5528de41-f8bc-4830-8597-cb00073d3817.png">

#### 15. Success!
<img width="1185" alt="15" src="https://user-images.githubusercontent.com/50480144/169125903-0b4f4d94-ace3-44b1-9680-c8af5147a4b1.png">

#### 16. Go back to your app and take note of the Client ID and Tenant ID
<img width="790" alt="16" src="https://user-images.githubusercontent.com/50480144/169125916-4d90f4dd-2391-473d-8bb2-029fd73d9024.png">

#### 17. In the script, you can either uncomment and use a Key Vault, or fill in the variables
<img width="895" alt="17" src="https://user-images.githubusercontent.com/50480144/169125925-68fd656b-d41b-428e-9d59-7166028cb127.png">

## Troubleshooting

You can use [jwt.ms](https://jwt.ms/) to validate your auth token and that it has the correct `roles`
