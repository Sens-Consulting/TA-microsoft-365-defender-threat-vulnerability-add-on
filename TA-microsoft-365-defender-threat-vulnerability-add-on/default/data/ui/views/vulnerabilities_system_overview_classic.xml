<form theme="dark" version="1.1">
  <label>Vulnerabilities System overview</label>
  <fieldset submitButton="false">
    <input type="dropdown" token="token_system">
      <label>System</label>
      <fieldForLabel>machine_system_tags</fieldForLabel>
      <fieldForValue>machine_system_tags</fieldForValue>
      <search>
        <query>| datamodel Vulnerabilities search
| `get_system_from_machinetags(.*system.*)`
| fields + machine_system_tags 
| mvexpand machine_system_tags 
| stats count by machine_system_tags
| where match(machine_system_tags,"system")
| fields - count
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
    </input>
    <input type="dropdown" token="token_device" searchWhenChanged="true">
      <label>Device</label>
      <choice value="*">All</choice>
      <default>*</default>
      <initialValue>*</initialValue>
      <fieldForLabel>nt_host</fieldForLabel>
      <fieldForValue>nt_host</fieldForValue>
      <search>
        <query>| inputlookup ms_defender_endpoint_machines_assets.csv
| eval machine_system_tags = split(category, "|") 
| eval system = mvindex(machine_system_tags, mvfind(machine_system_tags,".*.*system.*.*"))
| search system="*$token_system$*"
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </search>
    </input>
    <input type="time" token="token_time" searchWhenChanged="true">
      <label>Time period</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Devices</title>
      <single>
        <search>
          <query>| datamodel Vulnerabilities search
| `get_system_from_machinetags(.*system.*)`
| search system="*$token_system$*" Vulnerabilities.dest="$token_device$"
| stats dc(Vulnerabilities.dest)</query>
          <earliest>$token_time.earliest$</earliest>
          <latest>$token_time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
    <panel>
      <title>Vulnerabilities</title>
      <single>
        <title>Across all devices</title>
        <search>
          <query>| datamodel Vulnerabilities search
| `get_system_from_machinetags(.*system.*)`
| search system="*$token_system$*" Vulnerabilities.dest="$token_device$"
| stats dc(Vulnerabilities.cve)</query>
          <earliest>$token_time.earliest$</earliest>
          <latest>$token_time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
    <panel>
      <title>Average System Security Score</title>
      <single>
        <search>
          <query>| datamodel Vulnerabilities search
| `get_system_from_machinetags(.*system.*)`
| search system="*$token_system$*" Vulnerabilities.dest="$token_device$"
| dedup Vulnerabilities.dest, Vulnerabilities.cve
| stats avg(Vulnerabilities.cvss) as avg_cvss_score
| eval avg_cvss_score=round(avg_cvss_score,1)</query>
          <earliest>$token_time.earliest$</earliest>
          <latest>$token_time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.0</option>
        <option name="rangeColors">["0x53a051","0x006d9c","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[3,5,7]</option>
        <option name="refresh.display">progressbar</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>Top vulnerable devices</title>
      <table>
        <search>
          <query>| datamodel Vulnerabilities search 
| `get_system_from_machinetags(.*system.*)` 
| search system="*$token_system$*" Vulnerabilities.dest="$token_device$"
| rename Vulnerabilities.* as *
| stats latest(cvss) as cvss, latest(exposure_level) as exposure_level by dest, cve

| stats values(exposure_level) as "Exposure level", dc(cve) as "Unique vulnerabilities", sum(cvss) as total_cvss, avg(cvss) as avg_cvss by dest 
| eval "Total Cvss score"=round(total_cvss,1), "Avg Cvss score"=round(avg_cvss,1) 
| rename dest as Device 
| sort - total_cvss 
| fields - total_cvss, avg_cvss</query>
          <earliest>$token_time.earliest$</earliest>
          <latest>$token_time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Exposure level">
          <colorPalette type="map">{"Medium":#EC9960,"High":#AF575A,"Low":#006D9C}</colorPalette>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Top vulnerables systems</title>
      <chart>
        <search>
          <query>| datamodel Vulnerabilities search
| `get_system_from_machinetags(.*system.*)`
| stats dc(Vulnerabilities.cve) as Vulnerabilities by system
| sort - Vulnerabilities
| eval system=if(match(system,"Demo\ssystem\s1"),"Buttercup Billing","Buttercup Merch Shop")</query>
          <earliest>$token_time.earliest$</earliest>
          <latest>$token_time.latest$</latest>
        </search>
        <option name="charting.axisTitleX.visibility">collapsed</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.chart">bar</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Vulnerabilties over time</title>
      <chart>
        <search>
          <query>| datamodel Vulnerabilities search 
| `get_system_from_machinetags(.*system.*)`
| search system="*$token_system$*" Vulnerabilities.dest="$token_device$"
| spath
| eval status=ifnull(status,"Active")
| timechart span=1d dc(Vulnerabilities.cve) as cveid by status
| eval Active=if(Active==0,null(),Active)
| filldown Active
| table _time, Active, Fixed</query>
          <earliest>-30d@d</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">1</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.overlayFields">Fixed</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Active Vulnerabilties overview</title>
      <chart>
        <search>
          <query>| datamodel Vulnerabilities search 
| `get_system_from_machinetags(.*system.*)` 
| search system="*$token_system$*" Vulnerabilities.dest="$token_device$"
| rename Vulnerabilities.* as *
| stats latest(cvss) as cvss, latest(exposure_level) as exposure_level by dest, cve

| stats latest(cvss) as "CVSS score", count as "Devices with Cve" by cve
| eval cve=upper(cve)
| lookup cve_description.csv CveId as cve OUTPUT IsExploitAvailable
| rename cve as CVE
| eval IsExploitAvailable=if(IsExploitAvailable=0,"No","Yes")
| eval CVE = replace(CVE,"(CVE|TVM)-(\d+)-(\d+)","\2.\3") 
| fields IsExploitAvailable  "CVSS score" "Devices with Cve" CVE</query>
          <earliest>-30d@d</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">scatter</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Most common vulnerabilities</title>
      <table>
        <search>
          <query>| datamodel Vulnerabilities search
| `get_system_from_machinetags(.*system.*)`
| search system="*$token_system$*" Vulnerabilities.dest="$token_device$"
```CveId in lookup is uppercase``` 
| eval CveId=upper('Vulnerabilities.cve')
| dedup CveId, Vulnerabilities.dest
| lookup cve_description.csv CveId OUTPUT IsExploitAvailable, VulnerabilitySeverityLevel as Severity, VulnerabilityDescription as Description, LastModifiedTime, PublishedDate, RecommendedSecurityUpdateId
| stats count as Occurences by CveId, IsExploitAvailable, Severity, PublishedDate, LastModifiedTime, RecommendedSecurityUpdateId, Description
| table CveId, Occurences, Severity, IsExploitAvailable, Description
| sort - Occurences</query>
          <earliest>$token_time.earliest$</earliest>
          <latest>$token_time.latest$</latest>
        </search>
        <option name="count">5</option>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">false</option>
        <format type="color" field="IsExploitAvailable">
          <colorPalette type="list">[#708794,#DC4E41]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
        <drilldown>
          <link target="_blank">https://www.cve.org/CVERecord?id=$row.CveId$</link>
        </drilldown>
      </table>
    </panel>
  </row>
</form>