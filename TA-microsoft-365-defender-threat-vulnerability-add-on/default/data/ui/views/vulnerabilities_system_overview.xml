<form theme="dark" version="1.1">
  <label>Vulnerabilities System overview</label>
  <fieldset submitButton="false">
    <input type="dropdown" token="token_system">
      <label>System</label>
      <fieldForLabel>system</fieldForLabel>
      <fieldForValue>system</fieldForValue>
      <search>
        <query>| inputlookup ms_defender_endpoint_machines_assets.csv 
| fields + category 
| eval system = split(category, "|") 
| mvexpand system 
| stats count by system 
| fields - count</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
    </input>
    <input type="time" token="token_time" searchWhenChanged="true">
      <label>Time period</label>
      <default>
        <earliest>-30d@d</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Devices</title>
      <single>
        <title>Unique</title>
        <search>
          <query>| datamodel Vulnerabilities search
| `get_system_from_machinetags(.*system.*)`
| search system="*$token_system$*"
| stats dc(Vulnerabilities.dest)</query>
          <earliest>$token_time.earliest$</earliest>
          <latest>$token_time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
    <panel>
      <title>Vulnerabilities</title>
      <single>
        <title>Unique across all devices</title>
        <search>
          <query>| datamodel Vulnerabilities search
| `get_system_from_machinetags(.*system.*)`
| search system="*$token_system$*"
| stats dc(Vulnerabilities.cve)</query>
          <earliest>$token_time.earliest$</earliest>
          <latest>$token_time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
    <panel>
      <title>System Security Score</title>
      <single>
        <title>Device avg score</title>
        <search>
          <query>| datamodel Vulnerabilities search
| `get_system_from_machinetags(.*system.*)`
| search system="*$token_system$*"
| dedup azure_device_id, Vulnerabilities.cve
| stats avg(Vulnerabilities.cvss) as avg_cvss_score
| eval avg_cvss_score=round(avg_cvss_score,1)</query>
          <earliest>$token_time.earliest$</earliest>
          <latest>$token_time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.0</option>
        <option name="rangeColors">["0x53a051","0x006d9c","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[3,5,7]</option>
        <option name="refresh.display">progressbar</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>Avg days since vulnerability was detected</title>
      <single>
        <search>
          <query>| datamodel Vulnerabilities search
| `get_system_from_machinetags(.*system.*)`
| search system="*$token_system$*"
```CveId in lookup is uppercase``` 
| eval CveId=upper('Vulnerabilities.cve')
| lookup cve_description CveId OUTPUT IsExploitAvailable, VulnerabilitySeverityLevel, VulnerabilityDescription, LastModifiedTime, PublishedDate, RecommendedSecurityUpdateId
| eval time_diff=(now()-strptime(PublishedDate,"%Y-%m-%dT%H:%M:%S.%Q"))/86400
| stats avg(time_diff) as avg_time_diff
| eval avg_days=round(avg_time_diff)
| fields + avg_days</query>
          <earliest>$token_time.earliest$</earliest>
          <latest>$token_time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>Most vulnerable devices</title>
      <table>
        <search>
          <query>| datamodel Vulnerabilities search
| `get_system_from_machinetags(.*system.*)`
| search system="*$token_system$*"
| stats values(exposure_level) as "Exposure level", sum(Vulnerabilities.cvss) as total_cvss, avg(Vulnerabilities.cvss) as avg_cvss by Vulnerabilities.dest
| eval "Total Cvss score"=round(total_cvss,1), "Avg Cvss score"=round(avg_cvss,1)
| rename Vulnerabilities.dest as Device
| sort - total_cvss
| fields - total_cvss, avg_cvss</query>
          <earliest>$token_time.earliest$</earliest>
          <latest>$token_time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Exposure level">
          <colorPalette type="map">{"Medium":#EC9960,"High":#AF575A}</colorPalette>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Most common vulnerabilities</title>
      <table>
        <search>
          <query>| datamodel Vulnerabilities search
| `get_system_from_machinetags(.*system.*)`
| search system="*$token_system$*"
```CveId in lookup is uppercase``` 
| eval CveId=upper('Vulnerabilities.cve')
| lookup cve_description CveId OUTPUT IsExploitAvailable, VulnerabilitySeverityLevel as Severity, VulnerabilityDescription as Description, LastModifiedTime, PublishedDate, RecommendedSecurityUpdateId
| stats count as Occurences by CveId, IsExploitAvailable, Severity, PublishedDate, LastModifiedTime, RecommendedSecurityUpdateId, Description
| table CveId, Occurences, Severity, IsExploitAvailable, PublishedDate, LastModifiedTime, RecommendedSecurityUpdateId, Description
| sort - Occurences</query>
          <earliest>$token_time.earliest$</earliest>
          <latest>$token_time.latest$</latest>
        </search>
        <option name="count">5</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">false</option>
        <format type="color" field="IsExploitAvailable">
          <colorPalette type="list">[#708794,#DC4E41]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Distribution of OS Platform and Build in '$token_system$'</title>
      <viz type="treemap_app.treemap">
        <search>
          <query>| inputlookup ms_defender_endpoint_advancedhunting_deviceinfo_assets.csv 
| join azure_device_id type=left 
    [| inputlookup ms_defender_endpoint_machines_assets.csv 
    | eval machine_system_tags = split(category, "|") 
    | eval system = mvindex(machine_system_tags, mvfind(machine_system_tags,".*system.*"))]
| search system="*$token_system$*"
| stats count as Devices by OSPlatform, OSBuild
| replace "*" with "OS: *" in OSPlatform
| replace "*" with "Build: *" in OSBuild</query>
          <earliest>-30d@d</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="treemap_app.treemap.colorMode">sequential</option>
        <option name="treemap_app.treemap.maxCategories">10</option>
        <option name="treemap_app.treemap.maxColor">#006d9c</option>
        <option name="treemap_app.treemap.minColor">#00a2e9</option>
        <option name="treemap_app.treemap.numOfBins">5</option>
        <option name="treemap_app.treemap.showLabels">true</option>
        <option name="treemap_app.treemap.showLegend">false</option>
        <option name="treemap_app.treemap.showTooltip">true</option>
        <option name="treemap_app.treemap.useColors">true</option>
        <option name="treemap_app.treemap.useZoom">true</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
  </row>
</form>